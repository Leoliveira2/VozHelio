<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Voice Fun â€“ HÃ©lio & Cia</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">
<div class="bg-white shadow-xl rounded-xl p-8 w-full max-w-md space-y-6">
  <h1 class="text-2xl font-semibold text-center">ğŸ™ï¸ Voice Fun</h1>

  <!-- Controles -->
  <div class="flex justify-center gap-4">
    <button id="recBtn"   class="btn">Gravar</button>
    <button id="stopBtn"  class="btn" disabled>Parar</button>
  </div>

  <div id="effects" class="grid grid-cols-2 gap-4 text-center opacity-0 pointer-events-none">
    <button data-effect="normal" class="effect">Original</button>
    <button data-effect="helium" class="effect">HÃ©lio</button>
    <button data-effect="deep"   class="effect">Grave</button>
    <button data-effect="robot"  class="effect">RobÃ´</button>
    <button data-effect="echo"   class="effect col-span-2">Eco</button>
  </div>

  <audio id="player" controls class="w-full mt-2 hidden"></audio>
</div>

<style>
  .btn{ @apply bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-40;}
  .effect{@apply bg-emerald-500 text-white py-2 rounded-lg hover:bg-emerald-600;}
</style>

<script>
const recBtn   = document.getElementById('recBtn');
const stopBtn  = document.getElementById('stopBtn');
const effects  = document.getElementById('effects');
const player   = document.getElementById('player');

let mediaRecorder, audioChunks = [], audioBuffer;

// === ConfiguraÃ§Ãµes de Ã¡udio ===
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext();

// gravaÃ§Ã£o ---------------------------------------------------------------
recBtn.onclick = async () => {
  audioChunks = [];
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.start();
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.onstop = async () => {
    const blob = new Blob(audioChunks, {type:'audio/webm'});
    const arrayBuffer = await blob.arrayBuffer();
    audioBuffer = await ctx.decodeAudioData(arrayBuffer);
    player.src = URL.createObjectURL(blob);
    player.classList.remove('hidden');
    effects.classList.remove('opacity-0','pointer-events-none');
  };
  recBtn.disabled = true; stopBtn.disabled = false;
};
stopBtn.onclick = () => { mediaRecorder.stop(); recBtn.disabled = false; stopBtn.disabled = true; };

// reproduÃ§Ã£o com efeitos -----------------------------------------------
effects.onclick = e => {
  const eff = e.target.dataset.effect;
  if(!eff || !audioBuffer) return;

  const src = ctx.createBufferSource();
  src.buffer = audioBuffer;

  let nodeChainEnd = src;           // ponta da cadeia para conectar ao destino
  switch(eff){
    case 'helium':
      src.playbackRate.value = 1.7;
      break;
    case 'deep':
      src.playbackRate.value = 0.6;
      break;
    case 'robot': {
      const ring = ctx.createGain();
      const osc  = ctx.createOscillator();
      osc.frequency.value = 100;    // modulaÃ§Ã£o ~100 Hz
      osc.connect(ring.gain); osc.start();
      nodeChainEnd.connect(ring);
      nodeChainEnd = ring;
      break;
    }
    case 'echo': {
      const delay = ctx.createDelay(1.0);
      delay.delayTime.value = 0.25;
      const fb = ctx.createGain(); fb.gain.value = 0.4;
      delay.connect(fb); fb.connect(delay);
      nodeChainEnd.connect(delay);
      nodeChainEnd = delay;
      break;
    }
    // normal -> sem alteraÃ§Ãµes
  }

  nodeChainEnd.connect(ctx.destination);
  src.start();
};
</script>
</body>
</html>
